<!DOCTYPE html>
<html lang="en">
<head>
    <title>akka-viz - akka messages visualization.</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/style.css">
    <script type="text/javascript" src="frontend-jsdeps.js"></script>
    <script type="text/javascript" src="js/vivagraph.js"></script>
    <!-- Material Design fonts -->
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link href="//fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.7/css/bootstrap-material-design.min.css" rel="stylesheet">
</head>
<body>
<div id="graphview"></div>
<div id="thebox">

    <div class="panel panel-default">
        <div class="panel-heading">Actors</div>
        <div class="panel-body">
            <div id="actortree"></div>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">Messages</div>
        <div class="panel-body">
            <div id="messages"></div>
        </div>
    </div>
</div>

<script type="text/javascript" src="frontend-fastopt.js"></script>

<script type="text/javascript">

    function frontendApp() {
        return akka.viz.frontend.FrontendApp()
    }

    var graph = Viva.Graph.graph();

    var idealLength = 180;
    var layout = Viva.Graph.Layout.forceDirected(graph, {
        springLength: idealLength,
        springCoeff: 0.0008,
        dragCoeff: 0.02,
        gravity: -1.2
    });


    var graphics = Viva.Graph.View.svgGraphics();
    var nodeSize = 32;
    var highlightRelatedNodes = function (nodeId, isOn) {
        graph.forEachLinkedNode(nodeId, function (node, link) {
            var linkUI = graphics.getLinkUI(link.id);
            if (linkUI) {
                linkUI
                        .attr('stroke', isOn ? 'red' : 'gray')
                        .attr('marker-end', isOn ? 'url(#TriangleRed)' : 'url(#Triangle)');
            }
        });
    };

    graphics.node(function (node) {
        var ui = Viva.Graph.svg('g'),
        // Create SVG text element with user id as content
                svgText = Viva.Graph.svg('text').attr('y', '-4px').text(node.id),
                img = Viva.Graph.svg('image')
                        .attr('width', nodeSize)
                        .attr('height', nodeSize)
                        .link('https://secure.gravatar.com/avatar/' + node.data);

        ui.append(svgText);
        ui.append(img);

        $(ui).hover(function () { // mouse over
            highlightRelatedNodes(node.id, true);
        }, function () { // mouse out
            highlightRelatedNodes(node.id, false);
        });
        $(ui).click(function () {
            frontendApp().pickActor(node.id)
        });

        return ui;
    }).placeNode(function (nodeUI, pos) {
        nodeUI.attr('transform',
                'translate(' +
                (pos.x - nodeSize / 2) + ',' + (pos.y - nodeSize / 2) +
                ')');
    });

    var createMarker = function (id, color) {
        return Viva.Graph.svg('marker')
                .attr('id', id)
                .attr('viewBox', "0 0 10 10")
                .attr('refX', "10")
                .attr('refY', "5")
                .attr('stroke', 'light-gray')
                .attr('fill', color)
                .attr('markerUnits', "strokeWidth")
                .attr('markerWidth', "10")
                .attr('markerHeight', "5")
                .attr('orient', "auto");
    };

    var marker = createMarker('Triangle', 'gray');
    marker.append('path').attr('d', 'M 0 0 L 10 5 L 0 10 z');
    var markerRed = createMarker('TriangleRed', 'red');
    markerRed.append('path').attr('d', 'M 0 0 L 10 5 L 0 10 z');


    // Marker should be defined only once in <defs> child element of root <svg> element:
    var defs = graphics.getSvgRoot().append('defs');
    defs.append(marker);
    defs.append(markerRed);

    var geom = Viva.Graph.geom();

    graphics.link(function (link) {
        // Notice the Triangle marker-end attribe:
        return Viva.Graph.svg('path')
                .attr('stroke', 'gray')
                .attr('stroke-width', '4')
                .attr('marker-end', 'url(#Triangle)');
    }).placeLink(function (linkUI, fromPos, toPos) {
        // Here we should take care about
        //  "Links should start/stop at node's bounding box, not at the node center."

        // For rectangular nodes Viva.Graph.geom() provides efficient way to find
        // an intersection point between segment and rectangle
        var toNodeSize = nodeSize,
                fromNodeSize = nodeSize;

        var from = geom.intersectRect(
                        // rectangle:
                        fromPos.x - fromNodeSize / 2, // left
                        fromPos.y - fromNodeSize / 2, // top
                        fromPos.x + fromNodeSize / 2, // right
                        fromPos.y + fromNodeSize / 2, // bottom
                        // segment:
                        fromPos.x, fromPos.y, toPos.x, toPos.y)
                || fromPos; // if no intersection found - return center of the node

        var to = geom.intersectRect(
                        // rectangle:
                        toPos.x - toNodeSize / 2, // left
                        toPos.y - toNodeSize / 2, // top
                        toPos.x + toNodeSize / 2, // right
                        toPos.y + toNodeSize / 2, // bottom
                        // segment:
                        toPos.x, toPos.y, fromPos.x, fromPos.y)
                || toPos; // if no intersection found - return center of the node

        var data = 'M' + from.x + ',' + from.y +
                'L' + to.x + ',' + to.y;

        linkUI.attr("d", data);
    });

    // Finally render the graph with our customized graphics object:
    var renderer = Viva.Graph.View.renderer(graph, {
        graphics: graphics,
        layout: layout,
        container: document.getElementById("graphview")
    });
    renderer.run();



</script>
<script type="text/javascript" src="frontend-fastopt.js"></script>
<script type="text/javascript" src="frontend-launcher.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.5.7/js/material.min.js"/>
<script type="text/javascript">
    $.material.init()
</script>
</body>

</html>
